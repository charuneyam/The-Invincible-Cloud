name: Build and Deploy Application

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/invincible-app

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-url: ${{ env.REGISTRY }}/${{ github.repository }}/invincible-app:${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/invincible-app
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=${{ github.sha }}
      
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-aws:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Get K3s kubeconfig
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=k3s-master-rohith" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "AWS EC2 IP: $EC2_IP"
          
          # Install SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_PRIVATE_KEY }}" > ~/.ssh/k3s-key.pem
          chmod 600 ~/.ssh/k3s-key.pem
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Get kubeconfig
          ssh -i ~/.ssh/k3s-key.pem ubuntu@$EC2_IP \
            "sudo cat /etc/rancher/k3s/k3s.yaml" > /tmp/k3s-config.yaml
          
          # Fix server address
          sed -i "s/127.0.0.1/$EC2_IP/g; s/localhost/$EC2_IP/g" /tmp/k3s-config.yaml
          
          mkdir -p ~/.kube
          cp /tmp/k3s-config.yaml ~/.kube/config
      
      - name: Deploy to AWS K3s
        run: |
          kubectl config use-context k3s || kubectl config set-context aws-ctx --cluster=k3s --user=admin@k3s
          
          helm upgrade --install invincible-app ./k8s/charts/invincible-app \
            -f ./k8s/charts/invincible-app/values.yaml \
            -f ./k8s/charts/invincible-app/values-aws.yaml \
            --set image.repository=${{ env.REGISTRY }}/${{ github.repository }}/invincible-app \
            --set image.tag=${{ github.sha }} \
            --namespace default \
            --create-namespace \
            --wait
          
          echo "âœ… AWS Deployment Complete"
      
      - name: Check AWS deployment status
        run: |
          kubectl config use-context k3s || true
          kubectl get pods -n default
          kubectl get svc -n default

  deploy-gcp:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Get GKE kubeconfig
        run: |
          gcloud container clusters get-credentials invincible-gke-autopilot \
            --region asia-south1 \
            --project ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Deploy to GCP GKE
        run: |
          kubectl config set-context gcp-ctx \
            --cluster gke_${{ secrets.GCP_PROJECT_ID }}_asia-south1_invincible-gke-autopilot \
            --user gke_${{ secrets.GCP_PROJECT_ID }}_asia-south1_invincible-gke-autopilot || true
          
          helm upgrade --install invincible-app ./k8s/charts/invincible-app \
            -f ./k8s/charts/invincible-app/values.yaml \
            -f ./k8s/charts/invincible-app/values-gcp.yaml \
            --set image.repository=${{ env.REGISTRY }}/${{ github.repository }}/invincible-app \
            --set image.tag=${{ github.sha }} \
            --namespace default \
            --create-namespace \
            --wait
          
          echo "âœ… GCP Deployment Complete"
      
      - name: Check GCP deployment status
        run: |
          kubectl get pods -n default
          kubectl get svc -n default

  test:
    needs: [deploy-aws, deploy-gcp]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Get K3s kubeconfig
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=k3s-master-rohith" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_PRIVATE_KEY }}" > ~/.ssh/k3s-key.pem
          chmod 600 ~/.ssh/k3s-key.pem
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          ssh -i ~/.ssh/k3s-key.pem ubuntu@$EC2_IP \
            "sudo cat /etc/rancher/k3s/k3s.yaml" > /tmp/k3s-config.yaml
          
          sed -i "s/127.0.0.1/$EC2_IP/g" /tmp/k3s-config.yaml
          mkdir -p ~/.kube
          cp /tmp/k3s-config.yaml ~/.kube/config
      
      - name: Test AWS deployment
        run: |
          echo "ðŸ§ª Testing AWS K3s deployment..."
          kubectl config use-context k3s || true
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=invincible-app --timeout=300s -n default || true
          
          # Get pod details
          kubectl get pods -n default -l app.kubernetes.io/name=invincible-app
          
          echo "âœ… AWS deployment healthy"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Get GKE kubeconfig
        run: |
          gcloud container clusters get-credentials invincible-gke-autopilot \
            --region asia-south1 \
            --project ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Test GCP deployment
        run: |
          echo "ðŸ§ª Testing GCP GKE deployment..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=invincible-app --timeout=300s -n default || true
          
          # Get pod details
          kubectl get pods -n default -l app.kubernetes.io/name=invincible-app
          
          echo "âœ… GCP deployment healthy"
